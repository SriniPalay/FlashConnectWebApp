<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FlashConnect Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6;
        }
        .search-container {
            position: relative;
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
            z-index: 10;
            max-height: 20rem;
            overflow-y: auto;
            margin-top: 0.5rem;
        }
        .chat-card {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background: white;
            max-width: 500px;
        }
        .chat-header {
            font-weight: 600;
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
        }
        .chat-messages {
            min-height: 80px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 0.5rem;
            margin-bottom: 0.75rem;
            background-color: #f9fafb;
        }
        .chat-message {
            margin-bottom: 0.5rem;
        }
        .error-message {
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 0.5rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }
        .button-primary {
            background-color: #3b82f6; /* Blue-600 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .button-primary:hover {
            background-color: #2563eb; /* Blue-700 */
        }
        .button-danger {
            background-color: #ef4444; /* Red-500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .button-danger:hover {
            background-color: #dc2626; /* Red-600 */
        }
        .message-bubble {
            padding: 8px 12px;
            border-radius: 1rem;
            word-wrap: break-word;
            max-width: 75%;
        }
        .message-bubble.sent {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
        }
        .message-bubble.received {
            background-color: #e2e8f0;
            color: black;
            align-self: flex-start;
        }
        /* Notification Icon Styling */
        .notification-icon-container {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px; /* Adjust size as needed */
            height: 40px; /* Adjust size as needed */
            border-radius: 50%;
            background-color: #e5e7eb; /* Light gray background */
            color: #4b5563; /* Dark gray icon color */
            transition: background-color 0.2s;
        }
        .notification-icon-container:hover {
            background-color: #d1d5db;
        }
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background-color: #ef4444; /* Red dot */
            border-radius: 50%;
            width: 12px;
            height: 12px;
            box-shadow: 0 0 0 2px white; /* White border around red dot */
        }
    </style>
</head>
<body>

<div class="max-w-xl mx-auto p-6 bg-white rounded-lg shadow-lg mt-10">

    <div class="flex justify-between items-center mb-6 relative"> <h1 class="text-3xl font-bold text-center">FlashConnect Chat</h1>

        <div id="notificationIconContainer" class="notification-icon-container" title="Notifications">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
            <span id="notificationCountBadge" class="notification-badge hidden"></span>
        </div>
        <button id="logoutButton" class="button-danger hidden">Logout</button>
    </div>

    <div id="authSection">
        <div id="loginForm" class="p-8 bg-gray-50 rounded-lg">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Login</h2>
            <div class="mb-4">
                <input id="loginEmailInput" type="email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg" />
            </div>
            <div class="mb-4">
                <input id="loginPasswordInput" type="password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg" />
            </div>
            <button id="loginSubmitButton" class="button-primary w-full">Log In</button>
            <p class="mt-4 text-center text-sm text-gray-600">
                Don't have an account? <a href="#" id="showRegisterLink" class="text-blue-600 hover:underline">Register here</a>
            </p>
        </div>

        <div id="registerForm" class="p-8 bg-gray-50 rounded-lg hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Register</h2>
            <div class="mb-4">
                <input id="registerNameInput" type="text" placeholder="Name" class="w-full px-4 py-2 border rounded-lg" />
            </div>
            <div class="mb-4">
                <input id="registerEmailInput" type="email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg" />
            </div>
            <div class="mb-4">
                <input id="registerDesignationInput" type="text" placeholder="Designation" class="w-full px-4 py-2 border rounded-lg" />
            </div>
            <button id="registerSubmitButton" class="button-primary w-full">Register</button>
            <p class="mt-4 text-center text-sm text-gray-600">
                Already have an account? <a href="#" id="showLoginLink" class="text-blue-600 hover:underline">Log in here</a>
            </p>
        </div>
    </div>

    <div id="mainContent" class="hidden">
        <div id="debugInfo" class="mb-4 p-3 bg-gray-100 rounded text-sm text-gray-600 hidden">
            <strong>Debug Info:</strong>
            <div>API Base URL: <span id="debugApiUrl"></span></div>
            <div>Current User ID: <span id="debugUserId"></span></div>
            <div>Selected User ID: <span id="debugSelectedUserId">None</span></div>
        </div>

        <button id="toggleDebug" class="mb-4 px-3 py-1 bg-gray-200 rounded text-sm">Show Debug Info</button>

        <div class="search-container">
            <input
                    id="searchInput"
                    type="text"
                    placeholder="Search persons by name or email..."
                    class="w-full px-4 py-2 border rounded-lg"
                    autocomplete="off"
            />
            <div id="searchResults" class="search-results hidden"></div>
        </div>

        <div id="chatContainer" class="chat-card hidden">
            <div id="chatHeader" class="chat-header"></div>
            <div id="chatMessages" class="chat-messages flex flex-col space-y-2">
                <div class="text-center text-gray-500 p-4">Start the conversation!</div>
            </div>
            <div class="flex gap-2">
                <input
                        type="text"
                        id="chatInput"
                        placeholder="Type your message here..."
                        class="flex-1 px-3 py-2 border rounded-lg"
                />
                <button id="sendButton" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                    Send
                </button>
            </div>
        </div>
    </div>

</div>

<div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg p-6 shadow-2xl w-full max-w-sm text-center">
        <p id="message-box-text" class="text-gray-800 mb-4"></p>
        <button onclick="hideMessageBox()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">OK</button>
    </div>
</div>

<script>
    const API_BASE_URL = 'http://localhost:8081';
    const API_LOGIN_URL = `${API_BASE_URL}/api/users/login`;
    const API_REGISTER_URL = `${API_BASE_URL}/api/users/register`;
    const API_SEARCH_URL = `${API_BASE_URL}/api/users/search`;
    const API_MESSAGES_URL = `${API_BASE_URL}/api/messages/sendMessages`;
    // UPDATED: Corrected endpoint path to match the backend convention
    const API_UNREAD_COUNT_URL = `${API_BASE_URL}/api/messages/unreadCount`;
    const API_MARK_AS_READ_URL = `${API_BASE_URL}/api/messages/markAsRead`;

    const searchInput = document.getElementById("searchInput");
    const searchResults = document.getElementById("searchResults");
    const chatContainer = document.getElementById("chatContainer");
    const chatHeader = document.getElementById("chatHeader");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const sendButton = document.getElementById("sendButton");
    const debugInfo = document.getElementById("debugInfo");
    const toggleDebug = document.getElementById("toggleDebug");
    const authSection = document.getElementById("authSection");
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const loginSubmitButton = document.getElementById("loginSubmitButton");
    const registerSubmitButton = document.getElementById("registerSubmitButton");
    const showRegisterLink = document.getElementById("showRegisterLink");
    const showLoginLink = document.getElementById("showLoginLink");
    const logoutButton = document.getElementById("logoutButton");
    const mainContent = document.getElementById("mainContent");

    const notificationIconContainer = document.getElementById("notificationIconContainer");
    const notificationCountBadge = document.getElementById("notificationCountBadge");

    let currentUser = null;
    let selectedUser = null;
    let notificationCount = 0;
    // NEW: Polling variable to manage the interval
    let notificationPollingInterval;

    function showMessageBox(message) {
        document.getElementById('message-box-text').textContent = message;
        document.getElementById('message-box').style.display = 'flex';
    }

    function hideMessageBox() {
        document.getElementById('message-box').style.display = 'none';
    }

    toggleDebug.addEventListener("click", () => {
        debugInfo.classList.toggle("hidden");
        toggleDebug.textContent = debugInfo.classList.contains("hidden") ? "Show Debug Info" : "Hide Debug Info";
        updateDebugInfo();
    });

    function updateDebugInfo() {
        document.getElementById("debugApiUrl").textContent = API_MESSAGES_URL;
        document.getElementById("debugUserId").textContent = currentUser ? currentUser.id : "None";
        document.getElementById("debugSelectedUserId").textContent = selectedUser ? selectedUser.id : "None";
    }

    function debounce(func, delay) {
        let timer;
        return function (...args) {
            clearTimeout(timer);
            timer = setTimeout(() => func.apply(this, args), delay);
        };
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // UPDATED: Function to show/hide the notification badge
    function updateNotificationDisplay() {
        if (notificationCount > 0) {
            notificationCountBadge.classList.remove("hidden");
        } else {
            notificationCountBadge.classList.add("hidden");
        }
    }

    // NEW: Function to fetch notification count from backend via polling
    async function fetchNotificationCount() {
        if (!currentUser || !currentUser.id) {
            notificationCount = 0;
            updateNotificationDisplay();
            return;
        }

        try {
            // UPDATED: Using the corrected URL format with the user ID in the path
            const response = await fetch(`${API_UNREAD_COUNT_URL}/${currentUser.id}`, {
                headers: { 'Accept': 'application/json' }
            });

            if (!response.ok) {
                throw new Error(`Failed to fetch notification count: ${response.status}`);
            }

            const data = await response.json();
            notificationCount = data.unreadCount || 0;
            updateNotificationDisplay();
        } catch (error) {
            console.error("Error fetching notification count:", error);
            notificationCount = 0;
            updateNotificationDisplay();
        }
    }

    // NEW: Function to start the polling interval
    function startNotificationPolling() {
        if (notificationPollingInterval) {
            clearInterval(notificationPollingInterval);
        }
        // Check for notifications every 5 seconds (5000 milliseconds)
        notificationPollingInterval = setInterval(fetchNotificationCount, 5000);
    }

    // NEW: Function to stop polling
    function stopNotificationPolling() {
        if (notificationPollingInterval) {
            clearInterval(notificationPollingInterval);
            notificationPollingInterval = null;
        }
    }

    // NEW: Function to mark messages as read
    async function markMessagesAsRead() {
        if (!currentUser || !selectedUser) return;

        try {
            const payload = {
                senderId: selectedUser.id,
                recipientId: currentUser.id
            };
            const response = await fetch(API_MARK_AS_READ_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Failed to mark messages as read: ${response.status}`);
            }

            console.log("Messages marked as read.");
            // After marking as read, immediately refresh the notification count
            fetchNotificationCount();
        } catch (error) {
            console.error("Error marking messages as read:", error);
        }
    }


    // Display search results with "Message" button
    function displaySearchResults(users) {
        if (!users.length) {
            searchResults.innerHTML = '<div class="p-4 text-center text-gray-500">No results found.</div>';
            searchResults.classList.remove("hidden");
            return;
        }
        searchResults.innerHTML = "";
        users.forEach(user => {
            if (currentUser && user.id === currentUser.id) return;
            const div = document.createElement("div");
            div.className = "px-4 py-2 hover:bg-gray-100 flex justify-between items-center cursor-pointer";
            div.innerHTML = `
                <div>
                  <div class="font-semibold">${escapeHtml(user.name)}</div>
                  <div class="text-sm text-gray-600">${escapeHtml(user.email)}${user.designation ? ` (${escapeHtml(user.designation)})` : ''}</div>
                </div>
                <button class="message-btn bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition">Message</button>
            `;
            div.querySelector(".message-btn").addEventListener("click", e => {
                e.stopPropagation();
                openChat(user);
            });
            div.addEventListener("click", () => openChat(user));
            searchResults.appendChild(div);
        });
        searchResults.classList.remove("hidden");
    }

    // Fetch users by search query
    async function searchUsers(query) {
        if (!currentUser) return;
        if (!query.trim()) {
            searchResults.classList.add("hidden");
            searchResults.innerHTML = "";
            return;
        }
        searchResults.innerHTML = '<div class="p-4 text-center text-gray-500">Searching...</div>';
        searchResults.classList.remove("hidden");
        try {
            const response = await fetch(`${API_SEARCH_URL}?query=${encodeURIComponent(query)}`, {
                headers: { 'Accept': 'application/json' }
            });
            if (!response.ok) throw new Error("Search failed");
            const users = await response.json();
            displaySearchResults(users);
        } catch (err) {
            searchResults.innerHTML = `<div class="p-4 text-center text-red-600">Error: ${escapeHtml(err.message)}</div>`;
        }
    }

    // UPDATED: Open chat and mark messages as read
    function openChat(user) {
        selectedUser = user;
        chatHeader.textContent = user.name;
        chatMessages.innerHTML = '<div class="text-center text-gray-500 p-4">Start the conversation!</div>';
        chatInput.value = "";
        chatContainer.classList.remove("hidden");
        searchResults.classList.add("hidden");
        updateDebugInfo();
        // NEW: When you open a chat, mark messages from this user as read
        markMessagesAsRead();
    }

    function addChatMessage(message, isSelf, isError = false) {
        const div = document.createElement("div");
        if (isError) {
            div.className = "error-message";
            div.innerHTML = `<strong>Error:</strong> ${escapeHtml(message)}`;
        } else {
            const bubbleClass = isSelf ? "sent" : "received";
            const alignmentClass = isSelf ? "justify-end" : "justify-start";
            div.className = `flex ${alignmentClass}`;
            div.innerHTML = `<div class="message-bubble ${bubbleClass}">${escapeHtml(message)}</div>`;
        }
        if (chatMessages.querySelector('.text-center')) {
            chatMessages.innerHTML = '';
        }
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendMessages() {
        const msg = chatInput.value.trim();
        if (!msg || !selectedUser || !currentUser) {
            if (!currentUser) { showMessageBox("Please log in first."); }
            else if (!selectedUser) { showMessageBox("Please select a user to chat with first."); }
            return;
        }
        const originalMsg = msg;
        chatInput.value = "";
        sendButton.disabled = true;
        sendButton.textContent = "Sending...";
        try {
            const payload = {
                senderId: currentUser.id,
                recipientId: selectedUser.id,
                content: originalMsg
            };
            const response = await fetch(API_MESSAGES_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json", "Accept": "application/json" },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Server error ${response.status}: ${errorText}`);
            }
            addChatMessage(originalMsg, true);
        } catch (error) {
            console.error("Send message error:", error);
            addChatMessage(`Failed to send: ${error.message}`, false, true);
            chatInput.value = originalMsg;
        } finally {
            sendButton.disabled = false;
            sendButton.textContent = "Send";
            chatInput.focus();
        }
    }

    // UPDATED: Start polling on successful login
    async function login() {
        const email = document.getElementById("loginEmailInput").value;
        const password = document.getElementById("loginPasswordInput").value;
        if (!email || !password) { showMessageBox("Please enter both an email and a password."); return; }
        try {
            const payload = { email: email, password: password };
            const response = await fetch(API_LOGIN_URL, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Login failed: ${response.status} - ${errorText}`);
            }
            const user = await response.json();
            currentUser = user;
            authSection.classList.add("hidden");
            mainContent.classList.remove("hidden");
            logoutButton.classList.remove("hidden");
            updateDebugInfo();
            showMessageBox(`Logged in as ${currentUser.name}. You can now search for other users to chat with.`);
            // NEW: Start the notification polling after a successful login
            startNotificationPolling();
        } catch (error) {
            console.error("Login error:", error);
            showMessageBox(error.message);
        }
    }

    async function register() {
        const name = document.getElementById("registerNameInput").value;
        const email = document.getElementById("registerEmailInput").value;
        const designation = document.getElementById("registerDesignationInput").value;
        if (!name || !email || !designation) { showMessageBox("Please fill in all fields to register."); return; }
        try {
            const payload = { name: name, email: email, designation: designation };
            const response = await fetch(API_REGISTER_URL, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Registration failed: ${response.status} - ${errorText}`);
            }
            const newUser = await response.json();
            showMessageBox(`Registration successful! Your new User ID is ${newUser.id}. Please use this ID to log in.`);
            showLoginLink.click();
        } catch (error) {
            console.error("Registration error:", error);
            showMessageBox(error.message);
        }
    }

    // UPDATED: Stop polling on logout
    function logout() {
        // NEW: Stop the notification polling on logout
        stopNotificationPolling();
        currentUser = null;
        selectedUser = null;
        authSection.classList.remove("hidden");
        mainContent.classList.add("hidden");
        logoutButton.classList.add("hidden");
        chatContainer.classList.add("hidden");
        searchResults.classList.add("hidden");
        searchInput.value = "";
        notificationCount = 0;
        updateNotificationDisplay();
        updateDebugInfo();
        showMessageBox("You have been logged out.");
    }

    // NEW: Event listener for notification icon click
    notificationIconContainer.addEventListener("click", () => {
        if (notificationCount > 0) {
            showMessageBox(`You have unread messages. (Clicking this would show them)`);
            // For now, let's just clear notifications locally. A real app would open a notifications list.
            notificationCount = 0;
            updateNotificationDisplay();
        } else {
            showMessageBox("No unread messages.");
        }
    });

    // Set up event listeners
    loginSubmitButton.addEventListener("click", login);
    registerSubmitButton.addEventListener("click", register);
    logoutButton.addEventListener("click", logout);
    sendButton.addEventListener("click", sendMessages);
    chatInput.addEventListener("keydown", e => {
        if (e.key === "Enter") {
            e.preventDefault();
            sendMessages();
        }
    });
    searchInput.addEventListener("input", debounce(e => {
        searchUsers(e.target.value);
    }, 300));
    showRegisterLink.addEventListener("click", (e) => {
        e.preventDefault();
        loginForm.classList.add("hidden");
        registerForm.classList.remove("hidden");
    });
    showLoginLink.addEventListener("click", (e) => {
        e.preventDefault();
        registerForm.classList.add("hidden");
        loginForm.classList.remove("hidden");
    });

    // Initialize debug info and notification display on page load
    updateDebugInfo();
    updateNotificationDisplay(); // Ensure badge is hidden initially
</script>

</body>
</html>